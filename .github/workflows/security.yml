name: Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 1'  # ÊØèÂë®‰∏ÄËøêË°å
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        override: true
        
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Cache cargo index
      uses: actions/cache@v3
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Install cargo-audit
      run: cargo install cargo-audit
      
    - name: Run security audit
      run: |
        echo "üîç Running security audit..."
        cargo audit --json > audit-report.json || true
        
    - name: Parse audit results
      id: audit-results
      run: |
        if [ -f audit-report.json ]; then
          vulnerabilities=$(cat audit-report.json | jq -r '.vulnerabilities.found // false')
          count=$(cat audit-report.json | jq -r '.vulnerabilities.count // 0')
          
          echo "vulnerabilities=$vulnerabilities" >> $GITHUB_OUTPUT
          echo "count=$count" >> $GITHUB_OUTPUT
          
          if [ "$vulnerabilities" == "true" ] && [ "$count" -gt 0 ]; then
            echo "‚ùå Found $count security vulnerabilities"
            cat audit-report.json | jq -r '.vulnerabilities.list[] | "üö® \(.advisory.id): \(.advisory.title) in \(.package.name) v\(.package.version)"'
            exit 1
          else
            echo "‚úÖ No security vulnerabilities found"
          fi
        else
          echo "‚ö†Ô∏è Audit report not generated"
          exit 1
        fi
        
    - name: Upload audit report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-audit-report
        path: audit-report.json
        
    - name: Comment on PR
      if: github.event_name == 'pull_request' && steps.audit-results.outputs.vulnerabilities == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const count = parseInt('${{ steps.audit-results.outputs.count }}');
          const body = `üö® **Security Alert**: Found ${count} security vulnerabilities in dependencies.\n\nPlease review the audit report and update vulnerable dependencies.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  memory-leak-test:
    name: Memory Leak Test
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        override: true
        
    - name: Install Valgrind
      run: |
        sudo apt-get update
        sudo apt-get install -y valgrind
        
    - name: Build project
      run: |
        echo "üî® Building project..."
        cargo build --release
        
    - name: Run memory leak test
      run: |
        echo "üîç Running memory leak test with Valgrind..."
        chmod +x scripts/valgrind_memory_test.sh
        ./scripts/valgrind_memory_test.sh -b target/release/oxcache -o valgrind-report.txt || true
        
    - name: Upload memory leak report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: memory-leak-report
        path: valgrind-report.txt

  comprehensive-security:
    name: Comprehensive Security Check
    runs-on: ubuntu-latest
    needs: [security-audit, memory-leak-test]
    if: always()
    steps:
    - name: Security check summary
      run: |
        echo "üîí Security Check Summary"
        echo "========================"
        
        if [ "${{ needs.security-audit.result }}" == "success" ]; then
          echo "‚úÖ Security audit: PASSED"
        else
          echo "‚ùå Security audit: FAILED"
        fi
        
        if [ "${{ needs.memory-leak-test.result }}" == "success" ]; then
          echo "‚úÖ Memory leak test: PASSED"
        else
          echo "‚ö†Ô∏è  Memory leak test: ISSUES FOUND"
        fi
        
        echo "========================"
        
        if [ "${{ needs.security-audit.result }}" == "success" ] && [ "${{ needs.memory-leak-test.result }}" == "success" ]; then
          echo "üéâ All security checks passed!"
          exit 0
        else
          echo "‚ö†Ô∏è  Some security checks failed. Please review the reports."
          exit 1
        fi